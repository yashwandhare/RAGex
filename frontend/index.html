<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAGex // ARCHIVE</title>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* --- Palette --- */
            --bg-canvas: #F5F2E8;      
            --bg-paper: #F5F2E8; 
            
            --text-body: #333333;      
            --text-sub: #666666;       
            --text-inverse: #F5F2E8;   
            --text-blue: #253256;      

            --status-red: #ff6b6b;
            --status-green: #2b8a3e; /* Darker green for text readability */
            --status-green-glow: #51cf66;

            --border-subtle: rgba(0,0,0,0.06);
            
            /* Typography - STRICT */
            --font-serif: 'Libre Baskerville', serif;
            --font-sans: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            
            --radius-xl: 24px;
            --radius-lg: 16px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        html, body { scroll-behavior: smooth; }

        body { 
            background: var(--bg-canvas); 
            color: var(--text-body); 
            font-family: var(--font-sans); 
            margin: 0; 
            height: 100vh; 
            display: flex; 
            padding: 1.5rem; 
            gap: 1.5rem;
            overflow: hidden;
        }

        /* ================== OVERLAY ================== */
        .analyzing-overlay {
            position: fixed; inset: 0;
            background: rgba(14, 22, 37, 0.6);
            backdrop-filter: blur(0px); -webkit-backdrop-filter: blur(0px);
            z-index: 100; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-inverse); opacity: 0; transition: opacity 0.3s ease, backdrop-filter 0.4s ease;
        }
        .analyzing-overlay.active { display: flex; opacity: 1; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .analyzing-text { font-family: var(--font-serif); font-size: 1.5rem; letter-spacing: 1px; }
        .dots::after { content: ''; animation: dotAnim 1.5s steps(4, end) infinite; }
        @keyframes dotAnim { 0%, 20% { content: ''; } 40% { content: '.'; } 60% { content: '..'; } 80%, 100% { content: '...'; } }

        /* ================== SIDEBAR ================== */
        .sidebar {
            width: 280px;
            background: rgba(14, 22, 37, 0.7);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: var(--radius-xl);
            display: flex; flex-direction: column; padding: 1.5rem 1rem;
            color: var(--text-inverse); z-index: 20;
            transition: width 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }

        .brand-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem; padding: 0 0.5rem; min-height: 40px;
        }

        .brand-text {
            font-family: var(--font-serif); font-size: 1.4rem;
            color: var(--text-inverse); /* Static Cream Color */
            white-space: nowrap;
            font-weight: 400;
        }

        .collapse-btn {
            background: transparent; border: none; color: rgba(245, 242, 232, 0.5);
            cursor: pointer; font-size: 1.2rem; transition: 0.2s; padding: 5px;
        }
        .collapse-btn:hover { color: var(--text-inverse); }

        .new-chat-btn {
            background: rgba(245, 242, 232, 0.08); border: 1px solid rgba(245, 242, 232, 0.1);
            color: var(--text-inverse); padding: 0.9rem; border-radius: var(--radius-lg);
            cursor: pointer; font-family: var(--font-sans); font-size: 0.9rem; font-weight: 500;
            transition: all 0.3s ease; display: flex; align-items: center; justify-content: center;
            gap: 0.5rem; margin-bottom: 2rem; white-space: nowrap; overflow: hidden; height: 48px;
        }
        .new-chat-btn:hover { background: rgba(245, 242, 232, 0.9); color: var(--text-blue); }

        .session-list { flex: 1; overflow-y: auto; width: 100%; scrollbar-width: none; counter-reset: session-counter; }
        .session-list::-webkit-scrollbar { display: none; }

        .session-item {
            padding: 0.8rem 1rem; border-radius: var(--radius-lg); color: rgba(245, 242, 232, 0.6);
            cursor: pointer; margin-bottom: 0.5rem; transition: 0.2s; font-size: 0.9rem;
            display: flex; justify-content: space-between; align-items: center; height: 44px;
            counter-increment: session-counter;
        }
        .session-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
        .delete-btn { opacity: 0; background: none; border: none; color: inherit; cursor: pointer; padding: 4px; font-size: 1rem; }
        .session-item:hover .delete-btn { opacity: 1; }
        .session-item.active { background: rgba(245, 242, 232, 0.95); color: var(--text-blue); font-weight: 600; }

        /* Collapsed Sidebar */
        .sidebar.collapsed { width: 80px; padding: 1.5rem 0.5rem; }
        .sidebar.collapsed .brand-text, .sidebar.collapsed .delete-btn, .sidebar.collapsed .session-title { display: none; }
        .sidebar.collapsed .brand-header { justify-content: center; padding: 0; }
        .sidebar.collapsed .new-chat-btn .btn-text { display: none; }
        .sidebar.collapsed .new-chat-btn .btn-icon { display: block; font-size: 1.4rem; }
        .btn-icon { display: none; }
        .sidebar.collapsed .session-item { justify-content: center; }
        .sidebar.collapsed .session-item::after { content: counter(session-counter); font-weight: 600; color: inherit; }

        /* ================== MAIN AREA ================== */
        .main-content {
            flex: 1; background: transparent;
            display: flex; flex-direction: column; position: relative;
            overflow: hidden;
        }

        /* --- Setup View --- */
        .setup-container {
            flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 2rem; text-align: center; max-width: 800px; margin: 0 auto; width: 100%;
        }
        .setup-container.hidden { display: none; }

        h1 { font-family: var(--font-serif); font-size: 3rem; color: var(--text-blue); margin-bottom: 0.5rem; letter-spacing: -1.5px; font-weight: 400; }
        p.subtitle { font-family: var(--font-serif); color: var(--text-sub); font-size: 1.1rem; margin-bottom: 3rem; max-width: 550px; font-style: italic; font-weight: 400; }

        /* GLASS URL INPUT */
        .url-input-wrapper {
            width: 100%; position: relative;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(30, 64, 175, 0.15);
            padding: 8px; border-radius: var(--radius-lg);
            display: flex; transition: transform 0.2s;
        }
        .url-input-wrapper:focus-within { transform: scale(1.02); background: rgba(255, 255, 255, 0.5); border-color: rgba(30, 64, 175, 0.3); }

        .input-box {
            flex: 1; background: transparent; border: none; padding: 1rem 1.5rem;
            color: var(--text-body); font-size: 1rem; font-family: var(--font-sans); min-width: 0;
        }
        .input-box::placeholder { color: rgba(51, 51, 51, 0.5); }

        .action-btn {
            background: var(--text-blue); color: var(--bg-paper); border: none; padding: 0 2rem;
            border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer;
            font-family: var(--font-sans); letter-spacing: 0.5px; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .action-btn:hover { transform: translateY(-2px); opacity: 0.9; }

        /* --- Chat View --- */
        .chat-container { display: none; flex-direction: column; height: 100%; }
        .chat-container.active { display: flex; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .chat-header {
            padding: 1.2rem; display: flex; justify-content: center;
            border-bottom: 1px solid var(--border-subtle);
            background: rgba(245, 242, 232, 0.7); backdrop-filter: blur(10px); z-index: 10;
        }

        .target-url-display {
            font-size: 0.9rem; display: flex; align-items: center; gap: 0.6rem;
            background: rgba(14, 22, 37, 0.05); padding: 6px 16px; border-radius: 20px;
            font-family: var(--font-sans); font-weight: 600;
            transition: all 0.3s ease;
        }

        /* Status Colors for URL Display */
        .url-status.connected { color: var(--status-green); }
        .url-status.disconnected { color: var(--status-red); }

        .status-dot { width: 8px; height: 8px; border-radius: 50%; transition: background 0.3s ease; }
        .url-status.connected .status-dot { background: var(--status-green); }
        .url-status.disconnected .status-dot { background: var(--status-red); }

        .messages-area {
            flex: 1; overflow-y: auto;
            padding: 2rem 0; width: 100%; max-width: 900px; margin: 0 auto;
            display: flex; flex-direction: column; gap: 2.5rem; scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: rgba(30, 64, 175, 0.3) transparent;
        }
        
        .messages-area::-webkit-scrollbar {
            width: 8px;
        }
        
        .messages-area::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .messages-area::-webkit-scrollbar-thumb {
            background: rgba(30, 64, 175, 0.3);
            border-radius: 4px;
        }
        
        .messages-area::-webkit-scrollbar-thumb:hover {
            background: rgba(30, 64, 175, 0.5);
        }

        .msg-row { display: flex; width: 100%; flex-direction: column; animation: fadeIn 0.4s ease; }
        .msg-row.user { align-items: flex-end; }
        
        .bubble {
            max-width: 90%; padding: 1.5rem; border-radius: var(--radius-lg);
            font-size: 1.05rem; line-height: 1.7;
        }
        .bubble.user { background: var(--text-blue); color: var(--text-inverse); border-bottom-right-radius: 2px; }
        .bubble.bot { background: transparent; color: var(--text-body); font-family: var(--font-serif); padding: 0; font-weight: 400; }
        .bubble strong { font-weight: 700; }
        .bubble.bot strong { color: var(--text-blue); }
        .bubble.user strong { color: #ffffff; }

        .suggestions-container { display: flex; flex-wrap: wrap; gap: 0.8rem; margin-top: 1rem; }
        .suggestion-chip {
            background: rgba(255,255,255,0.4); border: 1px solid rgba(14, 22, 37, 0.2);
            backdrop-filter: blur(5px); color: var(--text-blue); padding: 0.6rem 1.2rem;
            border-radius: 24px; cursor: pointer; transition: 0.2s; font-family: var(--font-sans);
        }
        .suggestion-chip:hover { background: var(--text-blue); color: var(--text-inverse); }

        .meta-footer {
            margin-top: 1rem; padding-top: 0.5rem; font-size: 0.75rem; color: var(--text-sub);
            display: flex; gap: 1rem; border-top: 1px solid var(--border-subtle);
        }
        .meta-tag { background: rgba(0,0,0,0.04); padding: 3px 8px; border-radius: 4px; }
        .source-link { color: rgba(30, 64, 175, 0.65); text-decoration: none; border-bottom: 1px solid rgba(14, 22, 37, 0.15); transition: color 0.2s ease, border-color 0.2s ease; }
        .source-link:hover { color: var(--text-blue); border-bottom-color: rgba(14, 22, 37, 0.25); }

        /* GLASS CHAT INPUT */
        .chat-input-area {
            padding: 2rem 0; width: 100%; max-width: 900px; margin: 0 auto;
            background: linear-gradient(to top, var(--bg-paper) 80%, rgba(245, 242, 232, 0)); 
            z-index: 10;
        }

        .chat-bar {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(30, 64, 175, 0.15);
            border-radius: var(--radius-lg);
            display: flex; padding: 0.6rem;
            box-shadow: 0 4px 24px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .chat-bar:focus-within {
            box-shadow: 0 8px 30px rgba(0,0,0,0.1); transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.5);
            border-color: rgba(30, 64, 175, 0.3);
        }

        .chat-bar input {
            flex: 1; background: transparent; border: none; color: var(--text-body);
            padding: 0.8rem 1rem; font-size: 1rem; font-family: var(--font-sans); min-width: 0;
        }

        .send-btn {
            background: var(--text-blue); color: var(--bg-paper); border: none; width: 44px; height: 44px;
            border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; transition: 0.2s;
        }
        .send-btn:hover { transform: scale(1.1); }

        .loader {
            display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: var(--text-blue);
            animation: pulse 1s infinite; margin-right: 8px;
        }
        @keyframes pulse { 0% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.3; transform: scale(0.8); } }

        .mobile-only-nav { display: none; }
        .menu-toggle { display: none; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        
        @media (max-width: 768px) {
            .mobile-only-nav { display: block; }
            .sidebar {
                position: fixed; left: 0; top: 0; bottom: 0; transform: translateX(-100%);
                width: 80%; background: rgba(14, 22, 37, 0.98); border-radius: 0;
            }
            .sidebar.open { transform: translateX(0); }
            .collapse-btn { display: none; } 
            .messages-area, .chat-input-area { padding-left: 5%; padding-right: 5%; }
            .bubble { max-width: 95%; }
            .menu-toggle { display: block; }
        }
    </style>
</head>
<body>

    <div class="analyzing-overlay" id="analysisOverlay">
        <div class="analyzing-text dots">Analyzing</div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="brand-header">
            <span class="brand-text">RAGex</span>
            <button class="collapse-btn" onclick="toggleCollapse()" id="collapseBtn">¬´</button>
            <button class="menu-toggle" onclick="toggleSidebar()" style="margin-left:auto;">‚úï</button>
        </div>
        
        <button class="new-chat-btn" onclick="createNewSession()">
            <span class="btn-text">+ New Thread</span>
            <span class="btn-icon">+</span>
        </button>
        
        <div class="session-list" id="sessionList"></div>
    </div>

    <div class="main-content">
        <div class="mobile-only-nav">
            <button class="menu-toggle" style="color:var(--text-blue); display: block;" onclick="toggleSidebar()">‚ò∞</button>
        </div>

        <div class="setup-container" id="setupView">
            <h1 id="greetingTitle">Good Evening</h1>
            <p class="subtitle">
                Connect to a web source. The system will read, analyze, and structure the data into a hallucination-free index.
            </p>
            
            <div class="url-input-wrapper">
                <input type="text" id="urlInput" class="input-box" placeholder="https://example.com/article" value="https://www.geeksforgeeks.org/nlp/what-is-retrieval-augmented-generation-rag/" onkeypress="if(event.key==='Enter') handleIndex()">
                <button class="action-btn" id="indexBtn" onclick="handleIndex()">
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>
            <div id="indexLog" style="margin-top:1rem; color:var(--text-sub); font-size:0.8rem; min-height:1.2rem;"></div>
        </div>

        <div class="chat-container" id="chatView">
            <div class="chat-header">
                <div class="target-url-display url-status" id="urlStatusContainer">
                    <span class="status-dot"></span>
                    <span id="activeUrl">Disconnected</span>
                </div>
            </div>

            <div class="messages-area" id="messagesArea"></div>

            <div class="chat-input-area">
                <div class="chat-bar">
                    <input type="text" id="chatInput" placeholder="Ask a question..." onkeypress="if(event.key==='Enter') handleQuery()">
                    <button class="send-btn" onclick="handleQuery()">‚Üë</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function setGreeting(){
            const h = new Date().getHours();
            let greet = 'Good Evening';
            if (h < 12) greet = 'Good Morning';
            else if (h < 18) greet = 'Good Afternoon';
            document.getElementById('greetingTitle').textContent = greet;
        })();

        const API_BASE = "http://127.0.0.1:8000/api/v1";
        let sessions = [];
        let currentSessionId = null;
        let isSidebarCollapsed = false;

        createNewSession();

        function createNewSession() {
            const id = Date.now();
            sessions.unshift({
                id: id, url: "", history: [],
                domHTML: `<div class="msg-row bot"><div class="bubble bot"><strong>Analysis complete.</strong><br>How can I help you?</div></div>`
            });
            switchSession(id);
            if(window.innerWidth <= 768) toggleSidebar(false);
        }

        function switchSession(id) {
            if (currentSessionId) {
                const current = sessions.find(s => s.id === currentSessionId);
                if (current) current.domHTML = document.getElementById('messagesArea').innerHTML;
            }
            currentSessionId = id;
            const session = sessions.find(s => s.id === id);
            if (!session) return; 

            renderSidebar();

            // Update Status in Chat Header
            const statusContainer = document.getElementById('urlStatusContainer');
            const statusText = document.getElementById('activeUrl');
            
            if (!session.url) {
                // Setup Mode / Disconnected
                document.getElementById('setupView').classList.remove('hidden');
                document.getElementById('chatView').classList.remove('active');
                document.getElementById('messagesArea').innerHTML = session.domHTML;
                
                // Status Logic: Red
                statusContainer.className = 'target-url-display url-status disconnected';
                statusText.innerText = 'Disconnected';
            } else {
                // Chat Mode / Connected
                document.getElementById('setupView').classList.add('hidden');
                document.getElementById('chatView').classList.add('active');
                document.getElementById('messagesArea').innerHTML = session.domHTML;
                
                // Status Logic: Green
                statusContainer.className = 'target-url-display url-status connected';
                statusText.innerText = new URL(session.url).hostname;

                const area = document.getElementById('messagesArea');
                area.scrollTop = area.scrollHeight;
            }
        }

        function deleteSession(e, id) {
            e.stopPropagation();
            sessions = sessions.filter(s => s.id !== id);
            if (sessions.length === 0) createNewSession();
            else if (currentSessionId === id) switchSession(sessions[0].id);
            else renderSidebar();
        }

        function renderSidebar() {
            const list = document.getElementById('sessionList');
            list.innerHTML = '';
            
            sessions.forEach(s => {
                const div = document.createElement('div');
                div.className = `session-item ${s.id === currentSessionId ? 'active' : ''}`;
                let label = s.url ? new URL(s.url).hostname : "New Thread";
                if (s.history.length > 0) label = s.history[0].content.substring(0, 20) + "...";

                div.onclick = () => switchSession(s.id);
                div.innerHTML = `
                    <span class="session-title">${label}</span>
                    <button class="delete-btn" onclick="deleteSession(event, ${s.id})">‚úï</button>
                `;
                list.appendChild(div);
            });
        }

        function toggleCollapse() {
            const sidebar = document.getElementById('sidebar');
            const btn = document.getElementById('collapseBtn');
            isSidebarCollapsed = !isSidebarCollapsed;
            
            if (isSidebarCollapsed) {
                sidebar.classList.add('collapsed');
                btn.innerText = "¬ª";
            } else {
                sidebar.classList.remove('collapsed');
                btn.innerText = "¬´";
            }
        }

        function toggleSidebar(forceState) {
            const sidebar = document.getElementById('sidebar');
            if (forceState !== undefined) {
                if (forceState) sidebar.classList.add('open');
                else sidebar.classList.remove('open');
            } else {
                sidebar.classList.toggle('open');
            }
        }

        async function handleIndex() {
            const urlIn = document.getElementById('urlInput');
            const url = urlIn.value.trim();
            if (!url) return;

            const overlay = document.getElementById('analysisOverlay');
            overlay.classList.add('active');

            try {
                const res = await fetch(`${API_BASE}/index`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url, max_pages: 5 })
                });

                if (res.ok) {
                    const session = sessions.find(s => s.id === currentSessionId);
                    session.url = url;
                    const initialMsg = `<div class="msg-row bot"><div class="bubble bot"><strong>Analysis complete.</strong><br>Indexed <span style="text-decoration:underline;">${new URL(url).hostname}</span>. How can I help you?</div><div class="suggestions-container"><button class="suggestion-chip" onclick="handleQuery('Summarize this page')">Summarize this page</button></div></div>`;
                    session.domHTML = initialMsg;

                    setTimeout(() => {
                        overlay.classList.remove('active');
                        switchSession(currentSessionId);
                        // Re-add suggestion after switching
                        const area = document.getElementById('messagesArea');
                        if (area && area.children.length > 0) {
                            const lastRow = area.lastChild;
                            if (!lastRow.querySelector('.suggestions-container')) {
                                lastRow.innerHTML += `<div class="suggestions-container"><button class="suggestion-chip" onclick="handleQuery('Summarize this page')">Summarize this page</button></div>`;
                            }
                        }
                    }, 2000); 
                } else {
                    alert("Failed to index website.");
                    overlay.classList.remove('active');
                }
            } catch (e) {
                alert("Connection Error.");
                overlay.classList.remove('active');
            }
        }

        async function handleQuery(manualQuery = null) {
            const input = document.getElementById('chatInput');
            let q = manualQuery || input.value.trim();
            if (!q) return;

            // Special handling: summaries should never be refused; force a clear, direct prompt
            const session = sessions.find(s => s.id === currentSessionId);
            if (!session || !session.url) {
                addMessage('Please connect a URL first, then request a summary.', 'bot');
                return;
            }

            let displayQ = q;
            if (q.toLowerCase().includes('summarize this page')) {
                q = `Give a concise, factual summary of the currently indexed webpage (${session.url}). Use only the indexed content. Do not refuse or say information is missing; if a detail is absent, state so explicitly.`;
                displayQ = 'Summarize this page';
            }

            addMessage(displayQ, 'user');
            input.value = '';

            const loadingId = addLoadingBubble();
            const startTime = Date.now();

            try {
                const res = await fetch(`${API_BASE}/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: q, history: session.history })
                });
                
                const data = await res.json();
                removeMessage(loadingId);
                
                let confDisplay = 0;
                if (typeof data.confidence_score === 'number' && !isNaN(data.confidence_score)) {
                    confDisplay = Math.round(data.confidence_score * 100);
                } else if (typeof data.confidence === 'number' && !isNaN(data.confidence)) {
                    confDisplay = Math.round(data.confidence * 100);
                } else if (typeof data.confidence === 'string') {
                    const map = { high: 90, medium: 70, low: 50 };
                    const key = data.confidence.toLowerCase();
                    confDisplay = map[key] ?? 0;
                }

                addMessage(data.answer, 'bot', {
                    sources: data.sources,
                    confidence: confDisplay, 
                    latency: ((Date.now() - startTime)/1000).toFixed(2),
                    refusal: data.refusal,
                    suggestions: data.suggested_questions 
                });

                session.history.push({ role: 'user', content: q });
                session.history.push({ role: 'assistant', content: data.answer });
                renderSidebar();
            } catch (e) {
                removeMessage(loadingId);
                addMessage("System Error: Could not reach backend.", 'bot');
            }
        }

        function addMessage(text, role, meta = null) {
            const area = document.getElementById('messagesArea');
            const row = document.createElement('div');
            row.className = `msg-row ${role}`;
            
            let content = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            let metaHtml = '';
            let suggestionsHtml = '';

            if (meta) {
                let sourceLinks = 'Internal';
                if (meta.sources && meta.sources.length > 0) {
                    sourceLinks = meta.sources.map(s => {
                        try {
                            const urlObj = new URL(s);
                            return `<a href="${s}" target="_blank" class="source-link">${urlObj.pathname}</a>`;
                        } catch { return `<span class="source-link">${s}</span>`; }
                    }).join(', ');
                }
                
                metaHtml = `
                    <div class="meta-footer">
                        <span class="meta-tag">‚è± ${meta.latency}s</span>
                        <span class="meta-tag">‚ö° ${meta.confidence}%</span>
                        <span class="meta-tag">üîó ${sourceLinks}</span>
                    </div>`;

                if (meta.suggestions && meta.suggestions.length > 0) {
                    suggestionsHtml = `<div class="suggestions-container">`;
                    meta.suggestions.forEach(s => {
                        const safeS = s.replace(/'/g, "\\'"); 
                        suggestionsHtml += `<button class="suggestion-chip" onclick="handleQuery('${safeS}')">${s}</button>`;
                    });
                    suggestionsHtml += `</div>`;
                }
            }

            row.innerHTML = `<div class="bubble ${role} ${meta?.refusal ? 'refusal' : ''}">${content}${metaHtml}</div>${suggestionsHtml}`;
            area.appendChild(row);
            area.scrollTo({ top: area.scrollHeight, behavior: 'smooth' });
        }

        function addLoadingBubble() {
            const id = 'loader-' + Date.now();
            const area = document.getElementById('messagesArea');
            area.insertAdjacentHTML('beforeend', `<div id="${id}" class="msg-row bot"><div class="bubble bot"><span class="loader"></span> Thinking...</div></div>`);
            area.scrollTo({ top: area.scrollHeight, behavior: 'smooth' });
            return id;
        }

        function removeMessage(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }
    </script>
</body>
</html>